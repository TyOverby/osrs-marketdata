<!DOCTYPE html>

<head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.css">
</head>

<body>
    <div id="graph"> </div>
    Smoothing: <input id="smoothing" type="number" value="1"/>

    <script>
        function smoothing () {
            return Math.max(1, +document.querySelector("#smoothing").value);
        }
        function smooth(data) {
            var how_much = smoothing();
            let queue_low = []; 
            let queue_high = []; 

            return data.map(function ([time, low, high]){
                queue_low.push(low);
                queue_high.push(high);
                if (queue_low.length > how_much) {queue_low.shift()}
                if (queue_high.length > how_much) {queue_high.shift()}
                let low_avg = queue_low.reduce((a, b) => a + b, 0) / queue_low.length;
                let high_avg = queue_high.reduce((a, b) => a + b, 0) /queue_high.length;
                return [time, low_avg, high_avg];
            });
        }

        function process(data) {
            let lowest = Infinity;
            let highest = -Infinity;
            data.sort(([a], [b]) => a - b);
            data = smooth(data);
            data = data.map(function([time, low, high]) {
                lowest = Math.min(lowest, low);
                highest = Math.max(highest, high);
                return [new Date(time * 1000), high-low, low];
            });

            let padding = (highest - lowest) / 2;
            lowest = Math.max(lowest - padding, 0);
            highest = highest + padding;
            return {
                data,
                lowest,
                highest
            };
        }

        function load(element, d) {
            let { lowest, highest, data } = process(d);

            let opts = {
                labels: ["x", "delta", "low"],
                stackedGraph: true,
                valueRange: [lowest, highest],
                stepPlot: smoothing() === 1,
            };

            graph = new Dygraph(element, data, opts);

            setInterval(function() {
                fetch("http://159.65.40.110:8080/560")
                    .then(response => response.json())
                    .then(smooth)
                    .then(process)
                    .then(function({ lowest, highest, data }) {
                        graph.updateOptions({
                            file: data, 
                            valueRange: [lowest, highest],
                            stepPlot: smoothing() === 1,
                        });
                    });

            }, 1000);
        }

        fetch("http://159.65.40.110:8080/560")
            .then(response => response.json())
            .then(x => load(document.querySelector("#graph"), x));
    </script>
</body>